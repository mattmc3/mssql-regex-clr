-- https://docs.microsoft.com/en-us/sql/relational-databases/clr-integration-database-objects-user-defined-functions/clr-scalar-valued-functions
-- Instructions:
-- 1.) Compile CLR script into .dll
--     ```C:\Windows\Microsoft.NET\Framework\v2.0.50727\csc.exe /t:library RegexFunctions.cs```
-- 2.) Put .dll into path: C:\Program Files\Microsoft SQL Server\CLR\RegexFunctions.dll
-- 3.) Run this script
USE [master]
GO

-- First time...
CREATE ASSEMBLY RegexFunctions FROM 'C:\Program Files\Microsoft SQL Server\CLR\RegexFunctions.dll' WITH PERMISSION_SET = SAFE;
GO

--------------------------------------------------------------------------------
-- Alternatively...
-- https://stackoverflow.com/questions/4737686/how-to-generate-sql-clr-stored-procedure-installation-script-w-o-visual-studio
-- From SSMS object explorer, right click assembly and script
USE [master]
GO

/****** Object:  SqlAssembly [RegexFunctions]   Script Date: 6/25/2019 09:50:21 PM ******/
CREATE ASSEMBLY [RegexFunctions]
FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C0103007B9F35590000000000000000E00002210B010800000A00000006000000000000AE2800000020000000400000000040000020000000020000040000000000000004000000000000000080000000020000000000000300408500001000001000000000100000100000000000001000000000000000000000005C2800004F00000000400000D802000000000000000000000000000000000000006000000C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000B408000000200000000A000000020000000000000000000000000000200000602E72737263000000D80200000040000000040000000C0000000000000000000000000000400000402E72656C6F6300000C000000006000000002000000100000000000000000000000000000400000420000000000000000000000000000000090280000000000004800000002000500402200001C0600000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000133003004200000001000011000F00280400000A2D0C0F01280400000A16FE012B01160B072D087E0500000A0A2B1D0F00280600000A0F01280600000A1F32280700000A280800000A0A2B00062A0000133004005200000002000011000F00280400000A2D150F01280400000A2D0C0F02280400000A16FE012B01160B072D087E0900000A0A2B240F00280600000A0F01280600000A0F02280600000A1F32280A00000A280B00000A0A2B00062A000013300300B600000003000011000F00280400000A2D150F01280400000A2D0C0F02280C00000A16FE012B01160D092D0B7E0900000A0C38850000000F02280D00000A16FE0416FE010D092D087E0900000A0C2B6C0F01280600000A1F32730E00000A0A060F00280600000A6F0F00000A0B076F1000000A2C19076F1100000A6F1200000A0F02280D00000AFE0416FE012B01160D092D09007E0900000A0C2B2000076F1100000A0F02280D00000A6F1300000A6F1400000A280B00000A0C2B00082A0000133003006600000004000011000F00280400000A2D0C0F01280400000A16FE012B01160D092D087E1500000A0C2B410F01280600000A1F32730E00000A0A060F00280600000A6F0F00000A0B076F1000000A0D092D0A0016281600000A0C2B10076F1700000A1758281600000A0C2B00082A1E02281800000A2A000042534A4201000100000000000C00000076322E302E35303732370000000005006C00000068020000237E0000D40200004402000023537472696E6773000000001805000008000000235553002005000010000000234755494400000030050000EC00000023426C6F620000000000000002000001571D02000900000000FA013300160000010000000D0000000200000002000000050000000A00000018000000020000000600000004000000010000000300000000000A000100000000000600480041000A006E004F000E00A50090000E00B00090000E00D400900006001E01FE0006003E01FE000E0077015C010A00B4014F000A00EB014F000A00F1014F000A0003024F000A0031024F000000000001000000000001000100010010002300000005000100010051807B000A0051807F000A005020000000009600BA0018000100A020000000009600C700210003000021000000009600DD002C000600C421000000009600ED00370009003622000000008618F80040000B00000001008C01000002009201000001008C0100000200920100000300CE01000001008C0100000200920100000300E201000001008C010000020092013100F80044003900F80040004100F800400021009A014E001900A50152002100AA0156004900BA015A001900C20162002100A5016E004900DA0172002100C2017B0029009A014E002900AA0187004900F8008B004900EB0192005900F7014E0051001302980061001E028700610028029D006900AA0156002900A501AD002900C201B1006900390287000900F8004000080004000E0008000800130020001B0049002E000B00C1002E001300CA0040001B00490060001B00490080001B00490068008100A300B7000480000000000000000000000000000000002300000002000000000000000000000001003800000000000200000000000000000000000100410000000000020000000000000000000000010084000000000000000000003C4D6F64756C653E0055736572446566696E656446756E6374696F6E732E646C6C0055736572446566696E656446756E6374696F6E73006D73636F726C69620053797374656D004F626A6563740053797374656D2E546578742E526567756C617245787072657373696F6E730052656765784F7074696F6E7300586D7300586D73690053797374656D2E446174610053797374656D2E446174612E53716C54797065730053716C426F6F6C65616E0053716C537472696E6700497352656765784D617463680052656765785265706C6163650053716C496E7433320052656765784D6174636847726F7570005265676578496E646578002E63746F720053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465004D6963726F736F66742E53716C5365727665722E5365727665720053716C46756E6374696F6E41747472696275746500696E707574007061747465726E006765745F49734E756C6C004E756C6C006765745F56616C75650052656765780049734D61746368006F705F496D706C69636974007265706C6163656D656E74005265706C6163650067726F75704E756D004D617463680047726F7570006765745F537563636573730047726F7570436F6C6C656374696F6E006765745F47726F757073006765745F436F756E74006765745F4974656D0043617074757265006765745F496E64657800000003200000000000405E9AFAA26DB24CA620E41F00C36A2E0008B77A5C561934E0890306110904320000000433000000080002110D111111110A000311111111111111110A000311111111111111150800021115111111110320000104200101080401000000032000020306110D0320000E070003020E0E1109050001110D02050702110D02030611110800040E0E0E0E110905000111110E05070211110203200008062002010E110905200112290E0420001231052001122D080907041225122911110203061115050001111508090704122512291115020801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010000008428000000000000000000009E28000000200000000000000000000000000000000000000000000090280000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF25002040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000584000007C02000000000000000000007C0234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004DC010000010053007400720069006E006700460069006C00650049006E0066006F000000B801000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E003000000054001900010049006E007400650072006E0061006C004E0061006D0065000000550073006500720044006500660069006E0065006400460075006E006300740069006F006E0073002E0064006C006C00000000002800020001004C006500670061006C0043006F0070007900720069006700680074000000200000005C00190001004F0072006900670069006E0061006C00460069006C0065006E0061006D0065000000550073006500720044006500660069006E0065006400460075006E006300740069006F006E0073002E0064006C006C0000000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E0030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000B03800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
WITH PERMISSION_SET = SAFE

GO
--------------------------------------------------------------------------------

-- Enable CLR
sp_configure 'clr enabled', 1
RECONFIGURE WITH OVERRIDE

GO
CREATE FUNCTION IsRegexMatch(@input NVARCHAR(4000), @pattern NVARCHAR(4000)) RETURNS BIT AS
EXTERNAL NAME RegexFunctions.RegexFunctions.IsRegexMatch
GO

CREATE FUNCTION RegexReplace(@input NVARCHAR(4000), @pattern NVARCHAR(4000), @replacement NVARCHAR(4000)) RETURNS NVARCHAR(4000) AS
EXTERNAL NAME RegexFunctions.RegexFunctions.RegexReplace
GO

CREATE FUNCTION RegexMatchGroup(@input NVARCHAR(4000), @pattern NVARCHAR(4000), @groupNum int) RETURNS NVARCHAR(4000) AS
EXTERNAL NAME RegexFunctions.RegexFunctions.RegexMatchGroup
GO

CREATE FUNCTION RegexIndex(@input NVARCHAR(4000), @pattern NVARCHAR(4000)) RETURNS INT AS
EXTERNAL NAME RegexFunctions.RegexFunctions.RegexIndex
GO
